# Heavenly Drops â€“ IMAP/SMTP Email System
## Complete Implementation Guide

---

## Architecture Overview

```
Internet
   â”‚
   â–¼
[Nginx Reverse Proxy]
   â”œâ”€â”€ https://webmail.workandstudyabroad.com.tr  â†’ Roundcube (port 8080)
   â””â”€â”€ https://workandstudyabroad.com.tr/api     â†’ NestJS Backend (port 3000)
                                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                    â”‚
             [Postfix SMTP]                       [Dovecot IMAP]
              port 25/587/465                      port 143/993
                    â”‚                                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€ Shared Maildir â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              /var/mail/vhosts/
                                    â”‚
                          [PostgreSQL + Redis]
                         Logging Â· Jobs Â· Leads
```

---

## Services

| Service       | Container                     | Ports           | Purpose                     |
|---------------|-------------------------------|-----------------|------------------------------|
| Postfix       | heavenlydrops-postfix         | 25, 587, 465    | SMTP send/receive            |
| Dovecot       | heavenlydrops-dovecot         | 143, 993        | IMAP/POP3 mailboxes          |
| Roundcube     | heavenlydrops-roundcube       | 8080â†’80         | Webmail interface            |
| OpenDKIM      | heavenlydrops-opendkim        | (socket)        | Email signing / anti-spam    |
| Certbot       | heavenlydrops-certbot-mail    | â€“               | Let's Encrypt SSL            |

---

## DNS Records Required

Add these to your DNS zone for `workandstudyabroad.com.tr`:

```dns
; MX record
@               MX  10  mail.workandstudyabroad.com.tr.

; A records
mail            A       <YOUR_SERVER_IP>
webmail         A       <YOUR_SERVER_IP>

; SPF
@               TXT     "v=spf1 mx a:mail.workandstudyabroad.com.tr ~all"

; DKIM (generated by mail-setup.sh install)
mail._domainkey TXT     "v=DKIM1; k=rsa; p=<PUBLIC_KEY_FROM_KEYGEN>"

; DMARC
_dmarc          TXT     "v=DMARC1; p=quarantine; rua=mailto:admin@workandstudyabroad.com.tr"
```

---

## Installation

### 1. First-time install
```bash
sudo ./scripts/mail-setup.sh install
```
This will:
- Create all required data directories
- Generate DKIM keys
- Pull Docker images
- Issue Let's Encrypt certificates
- Start all containers
- Create default mail accounts

### 2. Start / Stop
```bash
./scripts/mail-setup.sh start
./scripts/mail-setup.sh stop
./scripts/mail-setup.sh status
```

### 3. Add a new mail user
```bash
./scripts/mail-setup.sh adduser jane@workandstudyabroad.com.tr
```

### 4. Change password
```bash
./scripts/mail-setup.sh passwd jane@workandstudyabroad.com.tr
```

---

## Mail Accounts

| Account                               | Role   | Purpose              |
|---------------------------------------|--------|----------------------|
| info@workandstudyabroad.com.tr        | Staff  | General inquiries    |
| support@workandstudyabroad.com.tr     | Staff  | Customer support     |
| sales@workandstudyabroad.com.tr       | Staff  | Sales team           |
| admin@workandstudyabroad.com.tr       | Admin  | System admin         |
| noreply@workandstudyabroad.com.tr     | System | Automated sends      |

---

## AI Automation Layer

### Email Inbox Polling
- Polls IMAP every 5 minutes for unread emails
- Classifies each email: `study_in_spain` | `work_in_czech` | `other`
- Creates or updates Lead records automatically

### AI vs Human Detection (`AiDetectorService`)
```
Score = (punctuation Ã— 0.15) + (sentence_length_variance Ã— 0.25)
      + (vocabulary_richness Ã— 0.20) + (boilerplate_matches Ã— 0.30)
      + (ai_signatures Ã— 0.10)
```
- Score â‰¥ 0.65 â†’ AI-generated
- Score 0.45â€“0.75 â†’ Deep OpenAI check (blended)
- Results stored in `email_ai_detection` table
- Mirrored on `email_logs.is_ai_generated` for fast queries

### Attachment Processor (`AttachmentProcessorService`)
| File Type | Extraction | Automation Triggered |
|-----------|-----------|---------------------|
| PDF       | pdf-parse  | lead-document-update |
| DOCX      | mammoth    | lead-document-update |
| CV/Resume | mammoth    | cv-intake-workflow   |
| Contract  | mammoth    | contract-review-workflow |
| Invoice   | mammoth    | finance-workflow     |
| Image     | stored     | (manual review)      |

### Form Parser (`FormParserService`)
Detects emails from web forms (WordPress, WPForms, Gravity Forms):
1. Detects form-submission pattern from subject + body structure
2. Parses field key/value pairs
3. Creates/updates Lead in AI Manager
4. Triggers workflow: `study-spain-onboarding` | `work-czech-onboarding` | `general-inquiry-workflow`

---

## Diagnostics

### Via Script
```bash
# Snapshot current state
./scripts/mail-diagnostics.sh snapshot

# Auto: snapshot â†’ apply command â†’ snapshot â†’ compare
./scripts/mail-diagnostics.sh auto "docker compose restart postfix"

# Compare two saved snapshots
./scripts/mail-diagnostics.sh report data/before.json data/after.json
```

### Via API
```bash
# Get latest health summary
GET /api/emails/diagnostics

# Trigger immediate diagnostic run (with before/after comparison)
POST /api/emails/diagnostics/run
{"beforeAfter": true}
```

### Checks Performed
| Check         | Interval  | Auto-repair              |
|---------------|-----------|--------------------------|
| SMTP verify   | 15 min    | Transporter reinit       |
| IMAP login    | 15 min    | Connection pool reset    |
| SSL cert expiry| 15 min   | Alert logged (cert renewal is external) |
| Roundcube web | 15 min    | Container auto-restart (restart: unless-stopped) |

---

## Auto-Updater

### Via Script
```bash
./scripts/auto-updater.sh
```

### Via API
```bash
POST /api/emails/updater/run       # trigger
GET  /api/emails/updater/status    # poll progress
```

### Update Lifecycle
1. **Check** â€“ compare current vs latest versions for all components
2. **Maintenance mode** â€“ pause queues, show loading screen overlay in dashboard
3. **Before snapshot** â€“ capture diagnostic state
4. **Install** â€“ update Roundcube (Docker pull) + npm packages
5. **Restart** â€“ restart backend container
6. **After snapshot** â€“ capture new state
7. **Report** â€“ human-readable before/after diff
8. **Auto-repair** â€“ retry diagnostics up to 3 times if any check fails
9. **Resume** â€“ unpause all services

---

## Dashboard

Access the Email System dashboard at:  
**AI Manager â†’ Email System** (sidebar nav)

The dashboard shows:
- ğŸŸ¢/ğŸŸ¡/ğŸ”´ Mail server health (SMTP, IMAP, SSL, Roundcube)
- Email activity stats (inbound, outbound, open rate)
- Company email accounts with webmail links
- â³ Pending AI reply approvals (with preview + approve button)
- Auto-updater progress bar + maintenance mode overlay
- Quick links to webmail, port info, SSL status

---

## API Endpoints

```
GET  /api/emails                   List emails with filters
GET  /api/emails/stats             Email statistics
GET  /api/emails/pending-approvals AI emails awaiting review
GET  /api/emails/dashboard         Aggregated dashboard data
GET  /api/emails/diagnostics       Latest mail-server health
POST /api/emails/diagnostics/run   Run immediate diagnostics
GET  /api/emails/updater/status    Auto-updater progress
POST /api/emails/updater/run       Trigger update check
POST /api/emails/detect-batch      Batch AI vs Human classification
POST /api/emails/:id/approve       Approve AI-generated reply
POST /api/emails/send              Manual email send
```

---

## Database Tables Added

| Table                  | Purpose                              |
|------------------------|--------------------------------------|
| `mail_accounts`        | Company mail account registry        |
| `email_attachments`    | Attachment metadata + extraction     |
| `email_ai_detection`   | AI vs Human detection results        |
| `form_submissions`     | Parsed web form data                 |
| `mail_diagnostics`     | SMTP/IMAP health check history       |
| `update_history`       | Package/container update log         |
| `email_system_dashboard` | Aggregated view (no inserts)       |

---

## Security Notes

- **TLS 1.2+** enforced on all mail ports (587, 993)
- **DKIM** signs all outbound mail
- **SPF** + **DMARC** configured via DNS
- **Roundcube** session timeout: 15 min; IP binding enabled
- **Attachment storage** is server-side only; never served directly via HTTP
- **Let's Encrypt** auto-renews via cron (daily 03:00 Istanbul time)
- SMTP auth only accepted over TLS (`smtpd_tls_auth_only = yes`)

---

## Troubleshooting

### SMTP not sending
```bash
docker logs heavenlydrops-postfix | tail -50
./scripts/mail-setup.sh diagnose
```

### IMAP login failing
```bash
docker logs heavenlydrops-dovecot | tail -50
docker compose -f email-server/docker-compose.mail.yml exec dovecot doveadm user '*'
```

### SSL certificate expired
```bash
sudo ./scripts/mail-setup.sh ssl
```

### Roundcube not loading
```bash
docker logs heavenlydrops-roundcube
docker compose -f email-server/docker-compose.mail.yml restart roundcube
```

### Full before/after repair cycle
```bash
./scripts/mail-diagnostics.sh auto "./scripts/mail-setup.sh start"
```
